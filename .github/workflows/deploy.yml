name: Deploy to Alibaba Cloud OSS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Clean previous build
      run: |
        # 确保清理之前的构建文件
        rm -rf public/
        rm -rf .quartz-cache/
      
    - name: Build site
      run: npm run quartz build
      
    - name: Install ossutil
      run: |
        # 下载并安装 ossutil
        wget http://gosspublic.alicdn.com/ossutil/1.7.7/ossutil64
        chmod 755 ossutil64
        sudo mv ossutil64 /usr/local/bin/ossutil
        
    - name: Configure Alibaba Cloud credentials
      run: |
        # 配置阿里云CLI凭据
        mkdir -p ~/.aliyun
        cat > ~/.aliyun/config.json << EOF
        {
          "current": "default",
          "profiles": [
            {
              "name": "default",
              "mode": "AK",
              "access_key_id": "${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_ID }}",
              "access_key_secret": "${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_SECRET }}",
              "region_id": "${{ secrets.ALIBABA_CLOUD_REGION_ID }}"
            }
          ]
        }
        EOF
        
    - name: Deploy to OSS
      env:
        OSS_BUCKET_NAME: ${{ secrets.OSS_BUCKET_NAME }}
        OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        ALIBABA_CLOUD_ACCESS_KEY_ID: ${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_ID }}
        ALIBABA_CLOUD_ACCESS_KEY_SECRET: ${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_SECRET }}
        ALIBABA_CLOUD_REGION_ID: ${{ secrets.ALIBABA_CLOUD_REGION_ID }}
        SITE_URL: ${{ secrets.SITE_URL }}
      run: |
        echo "🔧 配置ossutil..."
        # 使用正确的端点配置
        ossutil config -e "https://${{ secrets.OSS_ENDPOINT }}" -i "${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_ID }}" -k "${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_SECRET }}"
        
        echo "📤 开始同步到OSS..."
        # 同步文件到OSS
        ossutil sync public/ oss://${{ secrets.OSS_BUCKET_NAME }}/ --delete --force
        
        echo "✅ 同步完成！"
        
    - name: Deploy status
      run: |
        echo "✅ Site deployed to Alibaba Cloud OSS"
        echo "🌐 Site URL: ${{ secrets.SITE_URL }}"
        echo "🪣 Bucket: ${{ secrets.OSS_BUCKET_NAME }}" 