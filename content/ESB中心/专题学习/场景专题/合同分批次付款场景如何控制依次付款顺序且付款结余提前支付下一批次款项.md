---
aliases: ["1972888611530963996"]
title: 合同分批次付款场景如何控制依次付款顺序且付款结余提前支付下一批次款项
created: 2025-07-29
modified: 2025-07-29
tags: ['ESB中心']
theme: ESB中心
---

1.编写目的

在客户项目的合同付款场景中存在分批次付款的情况，实际付款明细更新规则较为复杂，允许一次付清多笔批次款项，但付款进度必须按照批次号由小到大更新，如计划分三个批次完成付款，三个批次的应付款金额分别为10、20、30，初始付款状态均为未付款，若第一次审批通过的付款金额是15，批次1的实付等于10且付款状态为已付款，批次2的实付等于5且付款状态为部分付款。综上所述，每次付款的时候，从未完成付款的最小批次号到最大批次号循环处理，若本次付款金额不足以支付当前批次未付金额，则更新当前批次的实付等于当前数值累加本次付款金额，付款状态等于部分付款，并结束循环；反之更新当前批次的实付等于应付且付款状态等于已付款，本次付款金额减去当前批次刚补上的未付金额，下一次批次继续循环相同的操作，直到本次未付款金额小于等于0即代表全部消耗光不足以支付下一批次。本期专题将会讲解上述场景如何通过动作流实现。

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/39ec3af9a3645512b05e7b70e4a5b97d.jpg)

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/a6fb599d8b13c430fff6704e1e7e5da3.jpg)

2.思路分析

该场景的核心思想在于按批次由小到大的顺序循环批次付款明细，依次判断本次付款金额余额是否足够支付当前批次的剩余未支付金额。其中存在的问题点在于：

1）每个合同的批次付款明细条数不确定，明细条数很大时，每次都从第1条开始把所有明细行都遍历一遍，动作流执行超时的风险变大，要尽可能减少循环的次数。减少循环次数的方式有两种，首先因为每次更新批次款项都是由小到达更新，小批次的款项肯定是优先付款完成，不必每次都从明细表第一行开始检测更新，从未完成付款的最小批次开始循环遍历即可，要想找到满足条件的最小批次号，可以用数据源查询组件的分组汇总查询最小值功能实现；其次循环遍历不是每次都要执行到批次付款明细的最后1行，可能在中间某一个批次付款完成之后本次付款金额就消耗完毕，不足以支付下一批次，此时可使用跳出循环组件实现提前终止循环。

2）本场景中，循环遍历数据明细有严格的顺序要求，必须按照批次号由小到大的顺序循环遍历批次付款明细，可以使用数据源查询组件的排序功能控制循环对象数据排列先后顺序。

3.实现步骤

3.1新建合同付款场景相关的合同档案表单和合同付款申请流程

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/d5a8ce89b9cf5d63e040047cd22042b8.jpg)

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/80786eac4f4d341bfeae51e6faba78c8.jpg)

3.2在合同付款流程的归档节点设置节点附加操作自定义动作流

结束节点添加节点附加操作，正向流转到达归档节点时执行自定义动作流，点击+新建动作流自动跳转到动作流设计页面并初始化触发组件为流程审批触发，在其下添加执行组件即可。

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/d0d6f8fe3c14a291e37afc75e55faea6.jpg)

添加数据源查询组件查询批次付款明细中未完成付款的最小批次作为循环处理开始的位置，再添加一个数据源查询组件，查询批次付款明细中批次大于等于最小未付款批次的明细行数据并通过排序功能将其按照批次号由小到大升序排列。

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/416987b09ac13a1dc86e7a11dd068c8f.jpg)

新增自定义变量，命名为本次付款金额，并通过变量赋值初始化为付款流程中的本次付款金额数值。

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/2dac4ee803047065caf1775ad133b671.jpg)

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/baf301e22381874ae42fe6dca6be79d7.jpg)

添加循环组件，循环对象是第2个数据源查询组件返回的排序后的未完成付款明细数据。

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/1f1761a83cf1b71b3cf6d812f023ff99.jpg)

循环内添加条件分支组件判断本次付款金额余额是否不足以支付当前循环批次的未付款金额即（应付金额-实付金额）>本次付款金额是否成立，若不足以支付则更新当前循环批次的付款状态为部分付款，实付金额+=本次付款金额变量，并通过变量赋值更新本次付款金额变量=0；

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/e1905e4cacc1173561937503663ac352.jpg)

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/a71d4e1e73dbf8513921e11c5503d24e.jpg)

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/4978631405105a3cc0454787f6f93ef9.jpg)

在第一个条件分支外部再添加一个条件分支，判断更新完当前批次的付款金额后本次付款金额是否有余额，余额不足则添加跳出循环组件提前结束循环，否则继续判断更新下一批次的付款情况。

