---
aliases: ["1967584836485970908"]
title: 明细表数据校验且提醒错误记录位置
created: 2025-07-29
modified: 2025-07-29
tags: ['ESB中心']
theme: ESB中心
---

**1.场景说明**

在【工程项目管理】应用中，提交采购付款单时，若付款明细中申请的本次付款金额超过订单规定剩余未付款金额，则阻止提交且弹窗提示出现错误的记录位置。对提交表单的明细表数据进行全局校验且在校验不通过时提示出错明细位置的功能可通过动作流条件分支、变量赋值和函数公式实现。

效果如下图所示

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/760033c8f700823227ec7c84cddd0a6d.jpg)

**2.功能简介**

创建动作流，设计变量error\_line用于存储错误明细的位置，当采购付款单上报时循环遍历明细表，校验每一项采购物资本次申请付款金额是否超过其在订单中规定的剩余未付款金额，若超出，则将该条明细的位置追加到error\_line变量，循环校验结束之后，若error\_line为空，则代表校验通过，保存本次采购付款申请信息并触发采购付款流程；反之校验失败，阻止数据上报和流程创建，并弹窗提示error\_line记录的出错行数。

**3.**操作说明**

1、设计采购付款表单，选择采购订单之后，自动填充采购付款明细表，如图1所示：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/a1566016bd345ef387fb4e70d6ec97f8.jpg)

图1 设计采购付款表单

2、新建动作流，触发时机为采购付款表单新建保存数据**执行前**，如图2所示：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/91af658cfe9717b3a10601d25fc92f3a.jpg)

图2 新建动作流

3、循环遍历明细表，依次校验每一条采购物资的本次申请付款金额是否超过订单规定的未付款金额，并记录出错行的位置。

如图3所示，新建**【内置-多次执行】**操作节点，循环方式为**指定次数**，循环次数为**LEN\_ARRAY(明细表对象)**，该函数用于计算集合对象的元素数量。

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/1cbd10abb2293b301b1b09b522350025.jpg)

图3 新建执行动作 内置-多次执行

添加两个变量分别是整数类型index（用于存储当前校验的明细行序号），初始值为0和文本类型的error\_line（用于存储所有校验不通过的明细行序号），初始值为空，如图4所示：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/59dc0594f72eb82a80080770a2ed9f77.jpg)

图4 设置参数变量

在多次执行操作节点内创建**【内置-条件分支】**操作节点，通过条件分支实现数据校验。当满足”本次支付金额>待支付金额”时，在其条件分支下添加**【变量赋值】**操作，对index和error\_line进行变量赋值。

由于明细行的位置是从0开始编码的，明细行的实际序号应该是【当前循环位置】+1，如图5所示：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/d675bedeec450995918dd01d0e6feba8.jpg)

图5 index变量赋值

随后通过**CONTACT（error\_line,、,TOSTRING（index））**函数，以”、“作为分隔符将出错行序号index追加到error\_line变量。

注意：

a) CONTACT()函数的操作对象是字符串类型，而index为数字类型，所以需要先调用TOSTRING()函数将其格式转换

b) 若直接将error\_line赋值为上述函数值，最终的error\_line会以、开头，因此在追加新的出错明细行序号之前，应先对error\_line进行空值校验，若error\_line为空，则代表当前追加的是第一条出错明细行序号，error\_line在空值的基础上直接拼接序号值，即CONTACT（error\_line,TOSTRING（index））；否则要先添加分隔符“、”。如图6所示：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/ebc1c93cccdd45714a67434351cd0b4f.jpg)

图6 校验当前追加的是否为第一条出错明细，并执行不同的追加操作

所有明细行全部校验完毕之后，再次对error\_line进行空值校验。

**注意：**此时的【内置-条件分支】操作节点应该添加在上述【内置-多次执行】节点外

若error\_line仍为空值，则不做任何阻止操作，允许数据上报触发采购付款流程；若error\_line不为空，则表示存在出错行，数据校验不通过，**此时添加【内置-页面交互】**操作，提醒用户“第error\_line 行数据校验出错！本次付款金额不得超过订单规定的未付款金额！“，并阻止后续操作，禁止表单提交。如图7所示：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/a7bb72625575ce8e3af450277b8bdb52.jpg)

图7 判断校验是否通过，若不通过则阻止表单提交并弹窗提示具体出错明细位置。

提示效果如图8所示：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/2c8694affcb95410de6b881f52163a68.jpg)

