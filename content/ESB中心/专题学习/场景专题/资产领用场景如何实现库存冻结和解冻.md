---
aliases: ["1969018467124941098"]
title: 资产领用场景如何实现库存冻结和解冻
created: 2025-07-29
modified: 2025-07-29
tags: ['ESB中心']
theme: ESB中心
---

**1、方案背景**

在资产领用管理场景中，由员工申请领用但是尚在审批流程中或者申请通过后尚未领取的物品应当进行库存冷冻操作，这部分冻结数量内的物品不允许他人申请领用，只有申请人领取被批准的资产后，锁定的库存才会被解冻。以上库存冻结和库存解冻的场景可以通过动作流实现。如何计算当前被冻结的物品数量并在合适的业务节点更新库存冻结数量，本文将为您逐一讲解。

效果如下

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/b800cbe124b6bbb23e5d1c5327371aeb.jpg)

**2、设计思路**

设计的核心在于如何计算资产的冻结数量以及冻结数量在何时进行更新。

针对第一个点，资产冻结的数量等于资产申请流程所有审批中或者待领取的资产总数，可以利用动作流的查询组件，对资产申请明细的物品和批准数量进行分组汇总，计算各个物品实时的冻结数量；

针对第二个点，在申请人填写资产申请数量发起流程、行政审批决定实际批准数量以及申请人领取资产这三个业务节点应当对资产的冻结数量进行更新，可以通过流程触发、事件触发和数据更新组件实现在特定的场景下更新冻结数量。

**3、操作说明**

1）搭建领用物品表单，包括资产名称、规格、单位、库存数量、冻结数量和可用数量等字段，其中可用数量是**运算字段**，运算公式为**库存数量-冻结数量：**

**![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/f90ec2bc9bb502d17a27b95a4295b35e.jpg)**

图1 领用物品表单

2）搭建资产领用申请流程表单，包括申请人、申请部门、申请时间、申请事由、领用状态、申请明细（包括申请物品、申请数量和批准数量）等字段，其中批准数量字段在流程的创建节点不显示，领用状态的默认值为审批中：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/348a8fff0d00ce7c58a30722990b6d9c.jpg)

图2 资产领用申请流程发起节点新建布局

**新增**一个资产领用申请流程表单的**表单布局**，用于行政审批节点填写最终的批准数量，其中领用数量字段是流程发起节点申请人填报的，审批人不可修改，**批准数量**字段由行政审批人填写且**必填**：![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/c4f39b5c793ffb1f62e4b88cd100480d.jpg)

图3 资产领用申请流程行政审批节点布局

3）搭建领用登记表单，包括领取人、领取部门、领取日期、关联领用申请流程、领取明细（包括物品名称、领取数量）等字段，数据创建时选择关联领用申请流程后，会自动带出流程申请的领用资产和最终批准的领用数量：![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/f4f80afcf92679a023ef19af363f0918.jpg)

图4 资产领用登记表单

4）创建资产领用申请流程，关联资产领用申请表单，设置流转路径，为发起节点->行政审批->结束节点，其中行政审批**节点设置附加操作**更新资产领用状态为已通过：

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/f7740f4920eba4901c13ed80967f54cf.jpg)

图5 流程行政审批节点后跟新领用状态为已通过

５）添加动作流实现资产领用申请流程触发时和行政审批通过后更新库存冻结数量。

①冻结数量的计算方式是对所有处于审批中或者已通过流程中的申请明细数据按照领取物品进行分组，对领取数量进行求和，得出每个物品的库存冻结数量，再更新其对应物品信息中的冷冻数量字段；

②值得注意的是，行政审批之前物品的冷冻数量由流程发起者申请的【领用数量】决定，但是行政审批之后冷冻数量应该以实际【批准数量】为准，为了统一计算基准，我们可以在流程触发之后设置【批准数量】默认值等于【领用数量】，那么在不同节点更新冻结数量时统一对【批准数量】进行求和就行了；

③动作流通过**eBuilder查询组件实现对数据的分组汇总计算**，但是直接从“eBuilder”数据源查询表单数据时会发现无法对明细表字段无法作为分组和汇总字段（例如本专题中的申请物品和批准数量就位于明细表中），解决办法是从**“业务模块－eBuilder表单”数据源获取明细表数据**，通过该模块获取明细表数据的**前提条件是数据源表单是eBuilder物理表**，业务表单和共享表暂不支持明细表数据的分组汇总

以下是动作流的配置过程：

触发时机是发起节点后和到达结束节点前

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/9718fb3c3670b0fbfcc9a31ecf7823d8.jpg)

图6 库存冻结触发动作

流程触发后设置【批准数量】默认值等于申请数量

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/31eca8b93d13eab433111e27a4bbaa7c.jpg)

图7、8 触发节点后设置批准数量默认值为申请领取数量

查询所有处于审批中和已确认的领用申请流程的申请明细，申请领用的物品按照物品分组，对【批准数量】进行汇总求和，计算各物品的库存冻结数量

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/10c02a9c685741ce4baf8b20fde36a0e.jpg)

图9 查询各物品当前应冻结数量

遍历查询结果，将计算出的冻结数量分别更新到对应冻结物品的物品信息当中

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/9dfb6a6da1f0bfc42bfe38b8ab23d7d4.jpg)

图10 按照计算的应冻结数量更新物品信息中的冻结数量字段

6）资产领用登记出库后，需要更新对应资产领用申请流程的状态为已领取，更新最新的库存冻结数量以及库存总数

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/66f37f4e911151a5f50dbdb1fe900b8d.jpg)

图11 领用登记出库时更新领用申请流程表单的领用状态为已领取

查询最新冻结数量

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/0c26318220356af2b3b748df5d282df7.jpg)

图12 重新计算当前库存部分解冻后的最新冷冻数量

更新物品冻结数量

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/a40e02e9a1aa8e975c960d066dd3a520.jpg)

图13 更新物品冻结数量

更新物品库存数量

![](https://myhelpdoc.oss-cn-heyuan.aliyuncs.com/mdimages/74e72332660ec4a58c0119088df73b45.jpg)

