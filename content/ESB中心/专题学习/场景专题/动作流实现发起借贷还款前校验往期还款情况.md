---
aliases: ["1971539742113627626"]
title: 动作流实现发起借贷还款前校验往期还款情况
created: 2025-07-15
modified: 2025-07-15
tags: ['ESB中心']
theme: ESB中心
---

**1.编写目的**

本期主要讲解房地产项目借贷的还款流程期次校验场景。借款人每次选择贷款项目的指定期次发起还款申请时，系统需要对当前期次前的往期还款情况进行校验，只有往期借款全部还清才能提交本期还款申请流程。

![](8a80ad32a3b2a4f6aafc470a800d128f.jpg)

本场景中利用动作流的数据源查询组件，实现对明细表数据的规则校验。主要包括如何获取到需要检验的明细数据以及如何判断明细表中是否存在不满足指定条件的数据。

**2.思路分析**

复杂规则校验场景可以通过动作流实现，项目还款流程发起时触发期次校验动作流，通过数据源查询组件查询期次号小于当前还款期次，且实还金额小于应还金额的款项数量，若数量大于0，则代表存在往期款项未还清，添加页面交互组件提示校验失败的原因，并阻止流程向后续审批节点流转。

**3.操作说明**

1、 **设计贷款项目管理基础表单**：项目、楼栋、房号、还款明细

![](cd0f2dd8fc807d5e3f9790bc1c84face.jpg)

2、 **设计关键业务表单**

项目还款申请，其中主要包括还款项目、还款人、借款金额、本次还款期次、本次还款金额和全部还款明细等信息。

其中选择项目、楼栋、房号、姓名后，系统自动检索该人员的总借款金额、借款日期和全部还款明细，自动填写到当前流程表单中，通过**字段联动**实现房号和姓名字段值改变时，执行动作流根据这两个字段查询人员的还款明细信息，查询结果反写到当前表单字段中。

![](e59b6f93591f3e07300c7c330808aaf0.jpg)

![](398c7bfe26d467a542379c1adee555d7.jpg)

2.1新建**自定义触发动作流**，输入参数为房号、姓名，都是单行文本类型；根据房号和姓名查询当前申请还款的房屋全部还款明细；并通过输出组件将查询结果返回，其中相同房屋的借款金额和借款日期是一致的，返回其中一条就可以，其余字段通过明细列表的形式返回。

其中数据源查询组件的配置项页数和每页条数控制的是取查询结果的第几页数据，并不控制查询结果的数据总量。如满足条件的结果有1000条，页数2，每页条数100并不代表取0到200条数据，而是代表把1000条数据按照每页100条，分为10页，返回第2页数据，最终得到的是100到200条数据。当数据量超过100时，如果页数设置为固定值，无法获取到全部查询结果，因此需要设置循环，逐页返回结果数据，直到没有下一页。

![](a477d78f94981862fad23127a75c221f.jpg)

![](6d9cdc41e29f7f6640e73a0c0fe621b3.jpg)![](163ab0583fd66868279a557d984e7f09.jpg)

![](ecd7e6c68dde64528f39423c6872893f.jpg)

2.2流程表单添加**字段联动**，联动对象为上述自定义触发动作流，输入参数为表单字段房号和姓名，输出结果映射到表单的借款金额/日期和还款明细

![](51d1e27b27e396b3e6ae3a8d17b8be78.jpg)

2.3本次还款期次是关联ebuilder类型的单选字段，关联还款明细表单，标题栏显示字段为还款期次；选择本次付款期次时仅展示未结清的款项期次（即实还金额不等于已还金额），通过**表单字段管理-浏览数据定义-数据范围设置**实现

![](87626f2a5b21c1f10b9f4d53905a6a6d.jpg)

![](0b9d123001c589cfa91359da02842bf0.jpg)

**3、** **设计项目付款申请流程及其校验动作流**

添加节点附加操作，当流程离开发起节点时，通过数据源查询组件，查询当前流程的还款明细表中满足以下条件的明细数据总数：主表数据ID等于流程表单数据ID，还款期次小于本次还款期次，实还金额小于应还金额，若结果数量大于0，则代表往期款项未还清，添加页面交互组件提示原因，并启用阻止后续操作，禁止流程提交

![](c2a6d6f4b92a8f35af6c57927f55eb19.jpg)

数据源查询组件通过**业务模块-ebuilder表单**这个分类才能直接查询到明细表数据，该分类下搜索明细表名称就会出现：明细表【所属主表】；还有一个前提是明细表所在的主表创建时必须是**独立表**

![](7f51acbfe1a2821300965581d4471fab.jpg)

流程表单主表的本次还款期次字段是关联ebuilder类型，参数本次还款期次（名称）返回的是文本类型的期次信息，不能直接进行大小于比较，可以通过value（）函数将其转换成数字进行比较

![](ca3e315ec2a7d898c5c30ff729da9638.jpg)

应付金额和实付金额是明细表的两个同表字段进行比较，需要将比较类型切换为**本表字段**（只有数据源选择业务模块-ebuilder表单分类下的表单才支持本表字段进行比较）

![](047eb359f36e6de07fc63540088eb7c2.jpg)

校验失败条件为数据源查询组件返回的查询结果数量大于0

![](c5151d51b4beac4fe40e1252f37b29fe.jpg)

页面交互组件启用阻止后续操作可阻止流程提交

![](1db1b09adf89144682a2ce4323a9656d.jpg)

当流程正常归档时，需要更新还款明细和项目还款流程中本次还款期次的实还金额和实还日期

![](1c45c4865249fe57fb15f8b1a39b0ad9.jpg)![](7429bf0a92f93bee4bd43a740d71db4f.jpg)

![](9616dc2cefc408a3b1022bb304e42fe6.jpg)

![](3a48454bf9efb177701c117389f79f25.jpg)